const poker={};(()=>{const G=()=>{try{ix}catch{return setTimeout(G,1)}const a=ix.el.byId("chat-box"),i=ix.el.byId("chat-box-title"),t=ix.el.byId("chat-box-body"),o=ix.el.byId("reset-chat-box-position-btn"),n=ix.el.byId("clear-chat-box-content-btn"),d=ix.el.byId("welcome-form"),r=[],x=ix.el.byId("waiting-view"),e=ix.el.byId("game-view"),l=ix.el.byId("game-status"),u=ix.el.byId("banker-control-panel"),s=()=>{t.scrollTop=1e6*t.clientHeight},y=(e,i="server")=>{t.appendChild(ix.el("div",{class:i,title:ix.chee.time.format()},[],e)),s()};let h=!1;const b=ix.io(),k={join:"joinPokerSocket",request:"receive",receive:"receive",joinRoom:"joinRoom",createRoom:"createRoom",roomJoined:"roomJoined",resumeGame:"resumeGame",bankerOrder:"bankerOrder",startGame:"startGame"},g={roomId:"",playerId:"",username:"",gameData:{},roomKey:""};poker.userdata=g;{const m=ix.el.byId("username-input"),p=ix.el.byId("room-id-input"),f=ix.el.byId("join-btn"),w=ix.el.byId("create-btn"),T=(e,i,t)=>{t<0&&(t=0),(i=i<0?0:i)>win.innerWidth-e.clientWidth&&(i=win.innerWidth-e.clientWidth),t>win.innerHeight-e.clientHeight&&(t=win.innerHeight-e.clientHeight),e.style.setProperty("--x",i+"px"),e.style.setProperty("--y",t+"px")},L=(i.ondragstart=e=>{const t=e.offsetX,o=e.offsetY;e.dataTransfer.effectAllowed="move",i.ondrag=e=>{var i=e.clientX,e=e.clientY;i&&e&&T(a,i-t,e-o)}},ix.el.addListener(i,"click",()=>{var e="collapsed";a.classList.contains(e)?(a.classList.remove(e),setTimeout(s,300)):a.classList.add(e)}),doc.body.ondragover=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},(e,i)=>{e.classList.add("show"),i&&T(e,i.clientX,i.clientY),r.push(e)}),D=(e,i=!0)=>{for(e&&i&&e.preventDefault();r.length;)r.pop().classList.remove("show")},j=(ix.el.addListener(doc,"click",e=>D(e,!1)),i.oncontextmenu=e=>{D(e);var i=o,t=getComputedStyle(a);"8px"==t.getPropertyValue("--x").trim()&&"8px"==t.getPropertyValue("--y").trim()||L(i,e)},t.oncontextmenu=e=>{D(e),t.innerHTML&&L(n,e)},ix.el.addListener(o,"click",()=>{a.style.removeProperty("--x"),a.style.removeProperty("--y")}),ix.el.addListener(n,"click",()=>{t.innerHTML=""}),e=>!(m.value.length<2&&(ix.popup.message("The username must have a minimum length of 2 characters.",{callback:()=>{e&&ix.el.unlock(e),m.focus()}}),1)));var c;p.onkeyup=e=>{"Enter"===e.key&&j()&&(p.value?f:w).click()},m.onkeyup=e=>{if("Enter"===e.key){if(!j())return;p.focus()}ix.query.set("username",m.value.trim(),1)},m.onblur=e=>{m.value=m.value.trim()},y("You can move this window by dragging the header."),ix.el.addListener(f,"click",e=>{if(ix.el.lock(f),j(f)){if(!p.value)return ix.el.unlock(f),w.click();var i;i=f,p.value.length<4?ix.popup.message("The room ID must have a minimum length of 8 characters.",{callback:()=>{i&&ix.el.unlock(i),p.focus()}}):(b.emit(k.joinRoom,{username:m.value,roomId:p.value}),ix.popup.show("Joining the room, please wait a moment...",{callback:()=>ix.el.unlock(f),isTemporary:!0}))}}),ix.el.addListener(w,"click",()=>{ix.el.lock(w),j(w)&&ix.popup.message("Would you like to create a new room?",{buttons:[{text:"No",callback:()=>ix.el.unlock(w)},{text:"Yes",tagName:"strong",callback:()=>{b.emit(k.createRoom,{username:m.value,gameName:"Blackjack"}),ix.popup.show("The room is being created, please wait a moment...",{callback:()=>ix.el.unlock(w),isTemporary:!0})}}]})}),ix.query.get("username")&&(m.value=ix.query.get("username")),ix.query.get("room")&&(p.value=ix.query.get("room"),p.setAttribute("readonly",""),ix.el.hide(p),ix.el.hide(w.parentElement),p.previousElementSibling.innerText="You are joining the room: "+p.value,ix.el.show(ix.el.byId("join-another-room"))),d.classList.contains("hidden")&&(c=loc.pathname.split("/").pop(),b.emit(k.resumeGame,c))}const v=e=>{console.error(e),ix.popup.throw(e)},I=(b.on("connect",()=>{if(h)return loc.reload();y("Welcome to the game."),b.emit(k.join)}),()=>{ix.el.hide(x),ix.el.show(e),ix.el.hide(ix.el.byId("footer-buttons")),e.children[0].appendChild(ix.el.byId("player-list-container")),e.children[2].appendChild(u),u.innerHTML="",h?ix.popup.show("遊戲已開始"):ix.popup.show("遊戲繼續")});b.on(k.startGame,I),b.on(k.roomJoined,e=>{var{roomId:e,playerId:i,username:t,gameData:o,roomKey:a}=e,n=ix.el.byId("room-id"),r=ix.el.byId("room-id-copy-btn"),l=ix.el.byId("room-id-copy-hint");const s=ix.el.byId("invite-link");var c=ix.el.byId("invite-link-copy-btn"),m=ix.el.byId("invite-link-copy-hint");if(b.emit(k.request,{name:"playerList"}),g.roomId=e,g.playerId=i,g.username=t,g.gameData=o,a){ix.el.show(u),ix.el.hide(ix.el.byId("waiting-for-banker-start")),g.roomKey=a;const p=ix.el.byId("banker-start-game",u);ix.el.addListener(p,"click",()=>{var e;ix.el.lock(p),ix.popup.message("已向服務器提交開始遊戲請求",{callback:()=>ix.el.unlock(p),isTemporary:!0}),(e={name:"startGame"}).key=g.roomKey,b.emit(k.bankerOrder,e)})}h&&v("Game is started."),ix.popup.show("成功加入遊戲",{durationSec:1}),d.remove(),ix.el.show(x),y(`Room ID: ${e}
Player ID: ${i}
Player Name: `+t),n.innerText="Room ID: "+e,s.innerText=s.href=loc.origin+"/games/21/join?room="+e,ix.el.copyBtnSetup(r,e,{hintEl:l,hintText:"Copy"}),ix.el.copyBtnSetup(c,()=>s.innerText,{hintEl:m,hintText:"Copy"}),e&&his.replaceState(0,0,"./"+i),"waiting"!=o.status&&I(),h=!0});b.on(k.receive,e=>{switch(e.name){case"updateGameData":var i=e.content;g.gameData=i,l.innerText=i.status;break;case"updateAction":break;case"message":ix.popup.message(e.content.text,e.content.option);break;case"chatBox":y(e.content);break;case"playerList":var i=e.content,t=ix.el.byId("player-list");t.innerHTML="",i.banker?t.appendChild(ix.el("li",{class:"text-lf banker-name"+(g.playerId===i.banker.id?" self":""),title:i.banker.id},[ix.el("span",{},[],""+i.banker.username),ix.el("span",{style:"user-select:none;"},[]," (莊家)"),g.playerId===i.banker.id?ix.el("span",{class:"you"},[]," (YOU)"):""])):ix.popup.message("警告：莊家已下線！",{isTemporary:!0});for(const n of i.playerList){var{id:o,username:a}=n;t.appendChild(ix.el("li",{title:o,class:"text-lf"+(g.playerId===o?" self":"")},[ix.el("span",{},[],a),g.playerId===o?ix.el("span",{class:"you"},[]," (YOU)"):""]))}break;case"error":v(e.content);break;case"console":console.log(e.content)}}),win.onclose=()=>{h&&ix.popup.message("連線已中斷",{isTemporary:!0}),y("Disconnect, wait for reconnection...")},b.on("disconnect",win.onclose)};G()})();